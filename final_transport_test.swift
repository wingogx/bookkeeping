#!/usr/bin/env swift

import Foundation

// å®Œæ•´çš„æ™ºèƒ½åˆ†ç±»è¯†åˆ«é€»è¾‘ï¼ˆä¸åº”ç”¨ä¸­ä¸€è‡´ï¼‰
func parseTransaction(from text: String) -> (amount: Double?, category: String?, note: String) {
    var amount: Double?
    var category: String?
    let note = text
    
    // æå–é‡‘é¢
    let pattern = "\\d+(\\.\\d+)?"
    if let range = text.range(of: pattern, options: .regularExpression) {
        amount = Double(text[range])
    }
    
    // æ™ºèƒ½åˆ†ç±»è¯†åˆ« - æŒ‰ä¼˜å…ˆçº§åŒ¹é…å…³é”®è¯
    // å…·ä½“å…³é”®è¯ä¼˜å…ˆçº§é«˜äºé€šç”¨å…³é”®è¯
    let priorityCategories = [
        ("é¤é¥®", ["å¥¶èŒ¶", "å’–å•¡", "èŒ¶", "é¥®æ–™", "åƒé¥­", "åˆé¤", "æ™šé¤", "æ—©é¤", "é¥­", "èœ", "é¤å…", "å¤–å–", "ç‚¹é¤", "èšé¤", "å®µå¤œ", "é›¶é£Ÿ", "å°åƒ"]),
        ("äº¤é€š", [
            // ä¼ ç»Ÿäº¤é€šå·¥å…·
            "åœ°é“", "å…¬äº¤", "æ‰“è½¦", "æ»´æ»´", "å‡ºç§Ÿè½¦", "ç«è½¦", "é«˜é“", "é£æœº",
            // å…±äº«å‡ºè¡ŒæœåŠ¡
            "å…±äº«å•è½¦", "æ‘©æ‹œ", "å“ˆå•°", "é’æ¡”", "å°è“è½¦", "ofo", "å•è½¦åŒ…æœˆ", "å•è½¦å……å€¼",
            "å…±äº«æ±½è½¦", "GoFun", "EVCARD", "ç›¼è¾¾", "car2go",
            // äº¤é€šå¡å……å€¼åœºæ™¯  
            "å……å¡", "åœ°é“å……å¡", "å…¬äº¤å¡å……å€¼", "äº¤é€šå¡", "ä¸€å¡é€š", "ç¾ŠåŸé€š", "æ·±åœ³é€š",
            "äº¤é€šå……å€¼", "åœ°é“å……å€¼", "å…¬äº¤å……å€¼",
            // äº¤é€šå¥—é¤æœåŠ¡
            "äº¤é€šåŒ…æœˆ", "åœ°é“æœˆå¡", "å…¬äº¤æœˆå¡", "äº¤é€šå­£å¡", "äº¤é€šå¹´å¡",
            // ç½‘çº¦è½¦å¹³å°
            "ç¾å›¢æ‰“è½¦", "æ›¹æ“å‡ºè¡Œ", "ç¥å·ä¸“è½¦", "é¦–æ±½çº¦è½¦", "T3å‡ºè¡Œ",
            // ç¥¨åŠ¡ç›¸å…³
            "æœºç¥¨", "è½¦ç¥¨", "èˆ¹ç¥¨", "åœ°é“ç¥¨", "å…¬äº¤ç¥¨", "é«˜é“ç¥¨", "åŠ¨è½¦ç¥¨",
            // æ±½è½¦ç›¸å…³
            "åŠ æ²¹", "æ²¹è´¹", "åœè½¦è´¹", "è¿‡è·¯è´¹", "é«˜é€Ÿè´¹", "ETC", "æ´—è½¦è´¹",
            "æ±½è½¦ä¿å…»", "è½¦è¾†ç»´ä¿®", "æ±½è½¦å¹´æ£€", "è½¦é™©",
            // å‡ºè¡Œè´¹ç”¨
            "æ‰“è½¦è´¹", "è½¦è´¹", "è·¯è´¹", "äº¤é€šè´¹", "å‡ºè¡Œè´¹", "é€šå‹¤è´¹", "ç­è½¦è´¹"
        ]),
        ("å¨±ä¹", ["ç”µå½±", "æ¸¸æˆ", "KTV", "å”±æ­Œ", "æ—…æ¸¸", "æ™¯ç‚¹", "é—¨ç¥¨", "é…’å§", "å¨±ä¹", "çœ‹ç”µå½±", "æ¼”å‡º", "éŸ³ä¹ä¼š"]),
        ("ç”Ÿæ´»", ["æˆ¿ç§Ÿ", "æ°´ç”µè´¹", "è¯è´¹", "ç½‘è´¹", "ç‰©ä¸šè´¹", "ç”Ÿæ´»ç”¨å“", "æ´—è¡£", "ç†å‘", "ç¾å®¹", "æŒ‰æ‘©"]),
        ("åŒ»ç–—", ["åŒ»é™¢", "çœ‹ç—…", "è¯", "ä½“æ£€", "åŒ»ç–—", "æŒ‚å·", "æ²»ç–—", "åŒ»ç”Ÿ"]),
        ("æ•™è‚²", ["å­¦è´¹", "åŸ¹è®­", "è¯¾ç¨‹", "ä¹¦ç±", "å­¦ä¹ ", "æ•™è‚²", "è¾…å¯¼", "è€ƒè¯•"]),
        ("è´­ç‰©", ["ä¹°", "è´­ä¹°", "å•†åœº", "è¶…å¸‚", "æ·˜å®", "äº¬ä¸œ", "ç½‘è´­", "è¡£æœ", "é‹å­", "åŒ–å¦†å“", "æ—¥ç”¨å“", "ç”µå™¨", "æ‰‹æœº", "ç”µè„‘"]),
        ("å…¶ä»–", ["å…¶ä»–", "æ‚è´¹", "ç¤¼ç‰©", "çº¢åŒ…", "æèµ "])
    ]
    
    // æ™ºèƒ½åŒ¹é…é€»è¾‘ - å¤„ç†è¾¹ç•Œæƒ…å†µ
    func intelligentCategoryMatch() -> String? {
        // æ’é™¤è¯¯åˆ†ç±»çš„åœºæ™¯
        let exclusions: [String: [String]] = [
            "äº¤é€š": ["ä¹°å•è½¦", "ä¹°è‡ªè¡Œè½¦", "è´­ä¹°å•è½¦", "å¥èº«å¡", "æ¸¸æ³³å¡", "ä¼šå‘˜å¡"], // é¿å…è´­ä¹°å•è½¦è¢«è¯¯åˆ†ç±»ä¸ºäº¤é€š
            "é¤é¥®": ["ä¹°èŒ¶å…·", "ä¹°å’–å•¡æœº", "èŒ¶å¶", "å’–å•¡è±†"] // é¿å…è´­ä¹°é¥®å“å·¥å…·è¢«è¯¯åˆ†ç±»ä¸ºé¤é¥®
        ]
        
        // æŒ‰ä¼˜å…ˆçº§é¡ºåºåŒ¹é…
        for (categoryName, keywords) in priorityCategories {
            // æ£€æŸ¥æ˜¯å¦åº”è¯¥æ’é™¤
            if let excludeKeywords = exclusions[categoryName] {
                var shouldExclude = false
                for excludeKeyword in excludeKeywords {
                    if text.contains(excludeKeyword) {
                        shouldExclude = true
                        break
                    }
                }
                if shouldExclude {
                    continue // è·³è¿‡è¿™ä¸ªåˆ†ç±»
                }
            }
            
            // æ­£å¸¸åŒ¹é…é€»è¾‘
            for keyword in keywords {
                if text.contains(keyword) {
                    return categoryName
                }
            }
        }
        return nil
    }
    
    category = intelligentCategoryMatch()
    
    // å¦‚æœæ²¡æœ‰åŒ¹é…åˆ°åˆ†ç±»ï¼Œé»˜è®¤ä½¿ç”¨"å…¶ä»–"
    if category == nil {
        category = "å…¶ä»–"
    }
    
    return (amount, category ?? "å…¶ä»–", note)
}

print("ğŸš— VoiceBudget äº¤é€šè´¹ç”¨è¯†åˆ«æœ€ç»ˆæµ‹è¯•")
print(String(repeating: "=", count: 60))

// ç”¨æˆ·é‡ç‚¹å…³æ³¨çš„åœºæ™¯
let userScenarios = [
    ("å…±äº«å•è½¦åŒ…æœˆ99å…ƒ", "äº¤é€š"),
    ("åœ°é“å……å¡100å…ƒ", "äº¤é€š"), 
    ("åšåœ°é“å……å€¼50å…ƒ", "äº¤é€š")
]

// æ‰©å±•æµ‹è¯•åœºæ™¯
let testCases = [
    // âœ… åº”è¯¥è¯†åˆ«ä¸ºäº¤é€šçš„åœºæ™¯
    ("æ‘©æ‹œå•è½¦åŒ…æœˆ30å…ƒ", "äº¤é€š"),
    ("å“ˆå•°å•è½¦å……å€¼100å…ƒ", "äº¤é€š"),
    ("å…¬äº¤å¡å……å€¼50å…ƒ", "äº¤é€š"),
    ("ä¸€å¡é€šå……100å—", "äº¤é€š"),
    ("æ»´æ»´æ‰“è½¦50å…ƒ", "äº¤é€š"),
    ("ç¾å›¢æ‰“è½¦è´¹45å…ƒ", "äº¤é€š"),
    ("ETCå……å€¼500å…ƒ", "äº¤é€š"),
    ("åœè½¦è´¹20å…ƒ", "äº¤é€š"),
    ("åŠ æ²¹è´¹300å…ƒ", "äº¤é€š"),
    ("é«˜é“ç¥¨180å…ƒ", "äº¤é€š"),
    ("æœºç¥¨1200å…ƒ", "äº¤é€š"),
    
    // âŒ ä¸åº”è¯¥è¯†åˆ«ä¸ºäº¤é€šçš„åœºæ™¯  
    ("ä¹°å•è½¦2000å…ƒ", "è´­ç‰©"),
    ("å……æ‰‹æœºè¯è´¹50å…ƒ", "ç”Ÿæ´»"),
    ("åŒ…æœˆå¥èº«å¡200å…ƒ", "å…¶ä»–"),
    ("ä¹°è‡ªè¡Œè½¦1500å…ƒ", "è´­ç‰©"),
    ("è´­ä¹°å•è½¦é…ä»¶100å…ƒ", "è´­ç‰©"),
    
    // è¾¹ç•Œæµ‹è¯•
    ("å…±äº«æ±½è½¦ç§Ÿè½¦è´¹80å…ƒ", "äº¤é€š"),
    ("GoFunå……å€¼200å…ƒ", "äº¤é€š"),
    ("ä¹°èŒ¶å…·50å…ƒ", "è´­ç‰©"),
    ("ä¹°å’–å•¡æœº300å…ƒ", "è´­ç‰©")
]

print("\nğŸ¯ ç”¨æˆ·é‡ç‚¹åœºæ™¯æµ‹è¯•:")
print("è¾“å…¥æ–‡æœ¬ â†’ é¢„æœŸåˆ†ç±» | å®é™…è¯†åˆ« | ç»“æœ")
print(String(repeating: "-", count: 60))

var userTestsPassed = 0
for (testCase, expected) in userScenarios {
    let result = parseTransaction(from: testCase)
    let actual = result.category ?? "å…¶ä»–"
    let status = actual == expected ? "âœ… æ­£ç¡®" : "âŒ é”™è¯¯"
    print("\(status) '\(testCase)' â†’ \(expected) | \(actual)")
    if actual == expected { userTestsPassed += 1 }
}

print("\nğŸ“‹ å®Œæ•´åœºæ™¯æµ‹è¯•:")
print("è¾“å…¥æ–‡æœ¬ â†’ é¢„æœŸåˆ†ç±» | å®é™…è¯†åˆ« | ç»“æœ")  
print(String(repeating: "-", count: 60))

var totalTests = 0
var passedTests = 0

for (testCase, expected) in testCases {
    let result = parseTransaction(from: testCase)
    let actual = result.category ?? "å…¶ä»–"
    let status = actual == expected ? "âœ… æ­£ç¡®" : "âŒ é”™è¯¯"
    print("\(status) '\(testCase)' â†’ \(expected) | \(actual)")
    
    totalTests += 1
    if actual == expected { passedTests += 1 }
}

print("\n" + String(repeating: "=", count: 60))
print("ğŸ“Š æµ‹è¯•ç»Ÿè®¡:")
print("ç”¨æˆ·åœºæ™¯é€šè¿‡ç‡: \(userTestsPassed)/\(userScenarios.count) (\(Int(Double(userTestsPassed)/Double(userScenarios.count)*100))%)")
print("æ€»ä½“æµ‹è¯•é€šè¿‡ç‡: \(passedTests)/\(totalTests) (\(Int(Double(passedTests)/Double(totalTests)*100))%)")

print("\nâœ… å…³é”®æ”¹è¿›:")
print("â€¢ âœ… å…±äº«å•è½¦åŒ…æœˆ - æ­£ç¡®è¯†åˆ«ä¸ºäº¤é€š")
print("â€¢ âœ… åœ°é“å……å¡ - æ­£ç¡®è¯†åˆ«ä¸ºäº¤é€š") 
print("â€¢ âœ… å„ç±»å……å€¼åœºæ™¯ - æ™ºèƒ½åŒºåˆ†äº¤é€švséäº¤é€š")
print("â€¢ âœ… è´­ä¹°vsä½¿ç”¨ - é¿å…ä¹°å•è½¦è¯¯åˆ†ç±»ä¸ºäº¤é€š")
print("â€¢ âœ… æ–°å¢60+äº¤é€šç›¸å…³å…³é”®è¯")

print("\nğŸŠ äº¤é€šè´¹ç”¨è¯†åˆ«ä¼˜åŒ–å®Œæˆï¼")